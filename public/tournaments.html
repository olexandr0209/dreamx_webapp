<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>DreamX ‚Äî Tournaments</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="style.css" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- –ù–∞—à –∑–∞–≥–∞–ª—å–Ω–∏–π core-—Å–∫—Ä–∏–ø—Ç -->
    <script src="dreamx_core.js"></script>
</head>

<body class="tournament-screen">
    <div class="top-bar-home">
        <div class="logo-main-top">DreamX</div>
    </div>

    <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∏–π —Å–∫—Ä–æ–ª-–±–ª–æ–∫ -->
    <div class="tournament-container">
    <h1 class="tournament-title">–û–±–µ—Ä–∏ –≥—Ä—É</h1>

    <!-- –®–≤–∏–¥–∫–∞ –≥—Ä–∞ -->
    <button class="mode-card" id="mode-vs-computer">
        <div class="mode-title">–¢–∏ vs –ö–æ–º–ø º—é—Ç–µ—Ä</div>
        <div class="mode-sub">–®–≤–∏–¥–∫–∞ –≥—Ä–∞ ‚Ä¢ –û—Ç—Ä–∏–º—É–π –º–æ–Ω–µ—Ç–∏</div>
    </button>

    <h2 class="tournament-subtitle">–¢—É—Ä–Ω—ñ—Ä–∏ DreamX</h2>

    <!-- –°—é–¥–∏ JS –ø—ñ–¥—Å—Ç–∞–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç—É—Ä–Ω—ñ—Ä—ñ–≤ -->
    <div id="tournaments-list">
        <!-- –º–æ–∂–Ω–∞ —Ç–∏–º—á–∞—Å–æ–≤–æ –∑–∞–ª–∏—à–∏—Ç–∏ —Ç—É—Ç –æ–¥–∏–Ω placeholder -->
    </div>
</div>

<div class="bottom-nav">
    <button class="bottom-btn bottom-btn-secondary" id="back-home">
        –ù–ê–ó–ê–î
    </button>
</div>

<script>
    // –ö–Ω–æ–ø–∫–∞ "–¢–∏ vs –ö–æ–º–ø º—é—Ç–µ—Ä"
    const modeBtn = document.getElementById("mode-vs-computer");
    if (modeBtn) {
        modeBtn.addEventListener("click", () => {
            const params = new URLSearchParams(window.location.search);
            params.delete("points");
            const qs = params.toString();
            window.location.href = qs ? `game.html?${qs}` : "game.html";
        });
    }

    // –ù–∞–∑–∞–¥ –Ω–∞ –≥–æ–ª–æ–≤–Ω—É
    const backBtn = document.getElementById("back-home");
    if (backBtn) {
        backBtn.addEventListener("click", () => {
            const params = new URLSearchParams(window.location.search);
            params.delete("points");
            const qs = params.toString();
            window.location.href = qs ? `index.html?${qs}` : "index.html";
        });
    }

    const tournamentListEl = document.getElementById("tournament-list");

    // ==== 1. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É —Ç—É—Ä–Ω—ñ—Ä—ñ–≤ –∑ –±–µ–∫–µ–Ω–¥–∞ ====
    async function loadTournaments() {
        if (!tournamentListEl) return;

        try {
            // üî• –¢–£–¢ –®–õ–Ø–•, –Ø–ö–ò–ô –¢–ò –ó–†–û–ë–ò–® –ù–ê –ë–ï–ö–ï–ù–î–Ü
            // —á–µ–∫–∞—î–º–æ JSON –º–∞—Å–∏–≤ —Ç—É—Ä–Ω—ñ—Ä—ñ–≤
            const res = await fetch("/api/get_tournaments");
            if (!res.ok) throw new Error("HTTP " + res.status);

            /** –û—á—ñ–∫—É–≤–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –µ–ª–µ–º–µ–Ω—Ç–∞:
             * {
             *   "id": 12,
             *   "title": "DreamX –¢—É—Ä–Ω—ñ—Ä #12",
             *   "host": "@Host",
             *   "starts_at": "2025-12-08T18:00:00Z",
             *   "players_total": 32,
             *   "players_left": 8,
             *   "status": "scheduled"
             * }
             */
            const tournaments = await res.json();

            tournamentListEl.innerHTML = "";

            if (!tournaments.length) {
                tournamentListEl.innerHTML =
                    '<div class="tour-empty">–ù–∞–π–±–ª–∏–∂—á–∏—Ö —Ç—É—Ä–Ω—ñ—Ä—ñ–≤ —â–µ –Ω–µ–º–∞—î‚Ä¶</div>';
                return;
            }

            tournaments.forEach(t => {
                const btn = document.createElement("button");
                btn.className = "mode-card tournament-card";
                btn.dataset.tournamentId = t.id;
                btn.dataset.startsAt = t.starts_at;  // ISO-–¥–∞—Ç–∞ –¥–ª—è —Ç–∞–π–º–µ—Ä–∞

                btn.innerHTML = `
                    <div class="tour-card-top">
                        <div class="mode-title">${t.title}</div>
                        <div class="tour-card-tag">–¢–£–†–ù–Ü–†</div>
                    </div>
                    <div class="mode-sub">
                        –û—Ä–≥–∞–Ω—ñ–∑–∞—Ç–æ—Ä: ${t.host || "‚Äî"}
                        ‚Ä¢ –ë—É–ª–æ ${t.players_total ?? "‚Äî"} ‚Üí –ó–∞–ª–∏—à–∏–ª–æ—Å—å ${t.players_left ?? "‚Äî"}
                    </div>
                    <div class="tour-card-bottom">
                        <span class="tour-card-start">
                            –°—Ç–∞—Ä—Ç: <span class="tour-card-start-time"></span>
                        </span>
                        <span class="tour-card-countdown" data-start="${t.starts_at}">
                            ...
                        </span>
                    </div>
                `;

                tournamentListEl.appendChild(btn);
            });

            attachTournamentHandlers();
            startCountdownLoop();
        } catch (err) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç—É—Ä–Ω—ñ—Ä—ñ–≤:", err);
            tournamentListEl.innerHTML =
                '<div class="tour-empty">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ç—É—Ä–Ω—ñ—Ä–∏‚Ä¶</div>';
        }
    }

    // ==== 2. –û–±—Ä–æ–±–Ω–∏–∫ –∫–ª—ñ–∫—É –ø–æ –∫–∞—Ä—Ç–æ—á—Ü—ñ —Ç—É—Ä–Ω—ñ—Ä—É ====
    function attachTournamentHandlers() {
        const cards = tournamentListEl.querySelectorAll(".tournament-card");
        cards.forEach(card => {
            card.addEventListener("click", () => {
                const id = card.dataset.tournamentId;
                const params = new URLSearchParams(window.location.search);
                params.delete("points");
                if (id) params.set("tournament_id", id);

                const qs = params.toString();
                window.location.href = qs
                    ? `tournament_game.html?${qs}`
                    : "tournament_game.html";
            });
        });
    }

    // ==== 3. –¢–∞–π–º–µ—Ä–∏ ‚Äî –æ–Ω–æ–≤–ª—é—î–º–æ –ø—ñ–¥–ø–∏—Å–∏ "72:00" ====
    function formatCountdown(diffMs) {
        if (diffMs <= 0) return "–ü–æ—á–∏–Ω–∞—î—Ç—å—Å—è!";

        const totalMinutes = Math.floor(diffMs / 60000);
        const hours = Math.floor(totalMinutes / 60);       // –∑–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–¥–∏–Ω
        const minutes = totalMinutes % 60;

        return `${hours}:${minutes.toString().padStart(2, "0")}`;
    }

    function updateCountdowns() {
        const now = Date.now();

        document.querySelectorAll(".tour-card-countdown").forEach(el => {
            const startISO = el.dataset.start;
            if (!startISO) return;

            const startTs = new Date(startISO).getTime();
            const diff = startTs - now;

            el.textContent = formatCountdown(diff);
        });

        // –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ –º–æ–∂–Ω–∞ –ø–æ–∫–∞–∑–∞—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–∏–π —á–∞—Å —Å—Ç–∞—Ä—Ç—É
        document.querySelectorAll(".tour-card-start-time").forEach(el => {
            const parent = el.closest(".tournament-card");
            if (!parent) return;
            const iso = parent.dataset.startsAt;
            if (!iso) return;
            const dt = new Date(iso);
            const hours = String(dt.getHours()).padStart(2, "0");
            const mins = String(dt.getMinutes()).padStart(2, "0");
            el.textContent = `${hours}:${mins}`;
        });
    }

    function startCountdownLoop() {
        updateCountdowns();
        // —Ä–∞–∑ –Ω–∞ 30 —Å–µ–∫—É–Ω–¥ ‚Äî –±—ñ–ª—å—à –Ω—ñ–∂ –¥–æ—Å—Ç–∞—Ç–Ω—å–æ
        setInterval(updateCountdowns, 30000);
    }

    // ==== 4. Bounce-–µ—Ñ–µ–∫—Ç –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (—è–∫ —Ä–∞–Ω—ñ—à–µ) ====
    const container = document.querySelector(".tournament-container");

    function hasScroll() {
        if (!container) return false;
        return container.scrollHeight > container.clientHeight;
    }

    function enableBounce() {
        if (!container) return;

        let startY = 0;
        let isDragging = false;
        let isMouse = false;

        container.addEventListener("touchstart", (e) => {
            if (hasScroll()) return;
            if (e.touches.length !== 1) return;

            isDragging = true;
            isMouse = false;
            startY = e.touches[0].clientY;
            container.style.transition = "none";
        });

        container.addEventListener("touchmove", (e) => {
            if (!isDragging || isMouse) return;
            if (hasScroll()) return;

            const currentY = e.touches[0].clientY;
            let delta = currentY - startY;

            const MAX = 40;
            delta = Math.max(-MAX, Math.min(MAX, delta));
            const softened = delta * 0.4;

            container.style.transform = `translateY(${softened}px)`;
        });

        const endTouch = () => {
            if (!isDragging || isMouse) return;
            isDragging = false;
            container.style.transition = "transform 0.25s ease-out";
            container.style.transform = "translateY(0)";
        };

        container.addEventListener("touchend", endTouch);
        container.addEventListener("touchcancel", endTouch);

        // –î–ª—è –Ω–æ—É—Ç–±—É–∫–∞
        container.addEventListener("mousedown", (e) => {
            if (hasScroll()) return;
            isDragging = true;
            isMouse = true;
            startY = e.clientY;
            container.style.transition = "none";
        });

        window.addEventListener("mousemove", (e) => {
            if (!isDragging || !isMouse) return;
            if (hasScroll()) return;

            const currentY = e.clientY;
            let delta = currentY - startY;

            const MAX = 40;
            delta = Math.max(-MAX, Math.min(MAX, delta));
            const softened = delta * 0.4;

            container.style.transform = `translateY(${softened}px)`;
        });

        window.addEventListener("mouseup", () => {
            if (!isDragging || !isMouse) return;
            isDragging = false;
            container.style.transition = "transform 0.25s ease-out";
            container.style.transform = "translateY(0)";
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        enableBounce();
        loadTournaments();   // üî• —Ç—è–≥–Ω–µ–º–æ —Ç—É—Ä–Ω—ñ—Ä–∏
    });
</script>
<script src="tournaments_screen.js"></script>
</body>
</html>
